---

## Prepare epel repo
- name: install epel repo
  yum:
    name: https://dl.fedoraproject.org/pub/epel/epel-release-latest-7.noarch.rpm
    state: present

## Install depencency
- name: install depencency packages
  yum: pkg={{ item }} update_cache=yes
  with_items:
    - python-pip
    - httpd
    - net-snmp
    - perl
    - mod_wsgi
    - python-devel
    - gcc
    - gcc-c++
    - pytz
    - MySQL-python 
    - libffi-devel
    - python-cairocffi

## Install graphite
- name: copy graphite-requirements file
  copy: src=graphite-requirements dest=/var/tmp/graphite-requirements

- name: install graphite packages
  pip: 
    requirements: /var/tmp/graphite-requirements

# Ensure directory exist
- name: Ensure /opt/graphite permission
  file:
    path: /opt/graphite
    state: directory
    owner: apache
    group: apache
    recurse: true

- name: Ensure data dir exist
  file:
    path: "{{ data_dir }}"
    state: directory
    owner: apache
    group: apache
    recurse: true

- name: Ensure log dir exist
  file:
    path: "{{ log_dir }}"
    state: directory

- name: Ensure web log dir exist
  file:
    path: "{{ log_dir }}/webapp"
    state: directory
    owner: apache
    group: apache


## Graphite web config
- name: copy graphite.wsgi to /opt/graphite/conf
  copy:
    src: web/graphite.wsgi
    dest: /opt/graphite/conf/graphite.wsgi

- name: copy graphTemplates.conf to /opt/graphite/conf
  copy:
    src: web/graphTemplates.conf
    dest: /opt/graphite/conf/graphTemplates.conf

- name: copy graphite-web-vhost.conf to /etc/httpd/conf.d/
  template:
    src: web/graphite-web-vhost.conf.j2
    dest: /etc/httpd/conf.d/graphite-web-vhost.conf

- name: copy graphite web local_settings.py to /opt/graphite/webapp/graphite/local_settings.py
  template:
    src: web/local_settings.py.j2
    dest: /opt/graphite/webapp/graphite/local_settings.py
