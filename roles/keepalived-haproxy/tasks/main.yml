---
## Install Keepalived + haproxy
- name: install keepalived packages
  yum: pkg={{ item }} update_cache=yes
  with_items:
    - keepalived
    - haproxy
    - rsyslog
    - psmisc

# Ensure log dir exist
- name: Ensure haproxy log dir exist
  file:
    path: "{{ log_dir }}"
    state: directory

## Haproxy config
- name: copy haproxy config to /etc/haproxy
  template:
    src: config/haproxy.cfg.j2
    dest: /etc/haproxy/haproxy.cfg

- name: copy haproxy log setting to /etc/rsyslog.d/
  template:
    src: log/haproxy_rsyslog.conf.j2
    dest: /etc/rsyslog.d/haproxy.conf

## Copy Keepalived config
- name: copy keepalived config to /etc/keepalived
  template: 
    src: config/keepalived.conf.j2
    dest: /etc/keepalived/keepalived.conf

### sysctl.conf
#- name: copy sysctl config to /etc/
#  template:
#    src: config/sysctl.conf.j2
#    dest: /etc/sysctl.conf
#

## Start firewalld 
- service:
    name: firewalld
    state: started

## stats web port
- firewalld:
    port: 80/tcp
    permanent: true
    state: enabled

## Riemann vip port
- firewalld:
    port: 12010/tcp
    permanent: true
    state: enabled

## carbon-relay vip port
- firewalld:
    port: 12020/tcp
    permanent: true
    state: enabled
